@model Carubbi.GenericRepository.PagedListResult<SmartLMS.WebUI.Models.AcessoViewModel>
@{
    ViewBag.Title = "Histórico de acessos";
    var paginaMax = Math.Ceiling(Model.Count / 8M);
    if (paginaMax > 10)
    {
        paginaMax = 10;
    }
}
<div class="panel panel-success">
    <div class="panel-heading">
        <h3 class="panel-title">Filtros da consulta</h3>
    </div>
    <div class="panel-body panel-body-no-margin">
        <div class="form-horizontal">
            <div class="col-md-4">
                <div class="form-group label-static is-empty">
                    <label class="control-label">Data Início</label>
                    <input class="datepicker form-control" type="text" id="dataInicio" value="@DateTime.Now.AddMonths(-1).ToShortDateString()" />
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group label-static is-empty">
                    <label class="control-label">Data Fim</label>
                    <input class="datepicker form-control" type="text" id="dataFim" value="@DateTime.Now.ToShortDateString()" />
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group label-static is-empty">
                    <label for="TipoAcesso" class="control-label">Tipo de Acesso</label>
                    @Html.DropDownList("TipoAcesso", ViewBag.TiposAcesso as SelectList, new { @class = "form-control dropdownjs" })
                </div>
            </div>
            <div class="text-right">
                <button id="btnFiltrar" class="btn btn-primary btn-sm">Filtrar</button>
            </div>
        </div>
    </div>
</div>
<div class="card">
    <div class="content">
        <h5 class="titulo-indice">
            Histórico de acessos
        </h5>
        <div>
            <div id="historico-container" class="list-group">
                @foreach (var item in Model.Entities)
                {

                    <div class="list-group-item list-group-item-sm">

                        @if (item.TipoAcesso == SmartLMS.Dominio.Servicos.TipoAcesso.Aula)
                        {
                            <a href="@Url.Action("Ver","Aula", new { Id = item.IdConteudo })" class='link-group-item'>
                                <div class="row-action-primary">
                                    <i class="fa fa-laptop"></i>
                                </div>
                                <div class="row-content">
                                    <h5 class="list-group-item-heading">@item.Nome</h5>
                                    <div class="progress progress-line-primary">
                                        <div class="progress-bar" role="progressbar" aria-valuenow="@item.Percentual" aria-valuemin="0" aria-valuemax="100" style="width: @item.Percentual%;">
                                            <span class="sr-only">@(item.Percentual)% Concluída</span>
                                        </div>
                                    </div>
                                    <p class="list-group-item-text">@item.NomeCurso</p>
                                    <div class="footer-content">@item.DataHoraTexto</div>
                                </div>
                            </a>
                        }
                        else
                        {
                            <a href="@Url.Action("BaixarArquivo","Aula", new { Id = item.IdConteudo })" class='link-group-item'>
                                <div class="row-action-primary">
                                    <i class="fa fa-laptop"></i>
                                </div>
                                <div class="row-content">
                                    <h5 class="list-group-item-heading">@item.Nome</h5>
                                    <p class="list-group-item-text">@item.NomeCurso</p>
                                    <div class="footer-content">@item.DataHoraTexto</div>
                                </div>
                            </a>
                        }
                    </div>
                    <div class="list-group-separator list-group-separator-sm"></div>
                }


            </div>
            <div class="text-center" id="paginacao-container">
                <ul class="pagination pagination-primary">

                    <li><a class="historico-paginacao-anterior" @if (!Model.HasPrevious) { <text> style="display:none" </text>  } href="javascript:void(0);">&lt; anterior</a></li>


                    @for (int i = 1; i <= paginaMax; i++)
                    {
                        if (i == 1)
                        {
                            @:<li class="active">
                        }
                        else
                        {
                            @:<li>
                        }

                        <a href="javascript:void(0);" class="historico-paginacao-pagina">@i</a>
                                @:</li>
                    }

                    <li><a class="historico-paginacao-proxima" @if (!Model.HasNext) { <text> style="display:none" </text>  } href="javascript:void(0);">próxima &gt;</a></li>

                </ul>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script type="text/x-handlebars-template" id="historico-template">
        {{#each Entities}}
        <div class="list-group-item list-group-item-sm">

            {{#equals TipoAcesso 1}}
            <a href="@Url.Content("~/")Aula/Ver/{{IdConteudo}}" class='link-group-item'>
                <div class="row-action-primary">
                    <i class="fa fa-laptop"></i>
                </div>
                <div class="row-content">
                    <h5 class="list-group-item-heading">{{Nome}}</h5>
                    <div class="progress progress-line-primary">
                        <div class="progress-bar" role="progressbar" aria-valuenow="{{Percentual}}" aria-valuemin="0" aria-valuemax="100" style="width: {{Percentual}}%;">
                            <span class="sr-only">{{Percentual}}% Concluída</span>
                        </div>
                    </div>
                    <p class="list-group-item-text">{{NomeCurso}}</p>
                    <div class="footer-content">{{DataHoraTexto}}</div>
                </div>
            </a>
            {{else}}
            <a href="@Url.Content("~/")Aula/BaixarArquivo/{{IdConteudo}}" class='link-group-item'>
                <div class="row-action-primary">
                    <i class="fa fa-laptop"></i>
                </div>
                <div class="row-content">
                    <h5 class="list-group-item-heading">{{Nome}}</h5>
                    <p class="list-group-item-text">{{NomeCurso}}</p>
                    <div class="footer-content">{{DataHoraTexto}}</div>
                </div>
            </a>
            {{/equals}}
        </div>
        <div class="list-group-separator list-group-separator-sm"></div>
        {{/each}}
    </script>

    <script id="paginacao-template" type="text/x-handlebars-template">

        <ul class="pagination pagination-primary">
            {{#if possuiAnterior}}
            <li><a class="historico-paginacao-anterior" href="javascript:void(0);">&lt; anterior</a></li>
            {{/if}}

            {{#for paginaMin paginaMax 1}}
            {{#equals this @@root.paginaCorrente}}
            <li class="active">
                {{else}}
            <li>
                {{/equals}}
                <a href="javascript:void(0);" class="historico-paginacao-pagina">{{this}}</a>
            </li>
            {{/for}}


            {{#if possuiProxima}}
            <li><a class="historico-paginacao-proxima" href="javascript:void(0);">próxima &gt;</a></li>
            {{/if}}
        </ul>

    </script>
    <script>
        SmartLMS.HistoricoProxy = (function () {
            $public = {}, $private = {};


            $public.Listar = function (dataInicio, dataFim, tipo, pagina) {
                return $.ajax({
                    type: "POST",
                    url: SmartLMS.api + "Usuario/ListarHistorico",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: JSON.stringify({ dataInicio: dataInicio, dataFim: dataFim, tipo: tipo, pagina: pagina })
                });
            };

            return $public;
        }());

        (function (historicoProxy) {
            var $private = {}, $public = {};

            $(function () {
                $private.UltimaQuantidade = @Model.Count
                $private.TipoAcesso = 0;
                $("#paginacao-container").on("click", ".historico-paginacao-pagina", $private.IrParaPagina);
                $("#paginacao-container").on("click", ".historico-paginacao-proxima", $private.ProximaPagina);
                $("#paginacao-container").on("click", ".historico-paginacao-anterior", $private.PaginaAnterior);
                $("#TipoAcesso").on("dropdownjs.change", function () {
                    var selectedItem = $(this).find("option:selected");
                    $private.TipoAcesso = selectedItem.val();

                });
                $("#btnFiltrar").on("click", $private.ConsultarHistorico);
                $private.PaginacaoTemplate = Handlebars.compile($("#paginacao-template").html());
                $private.HistoricoTemplate = Handlebars.compile($("#historico-template").html());

            });

            $private.Pagina = 1;

            $private.IrParaPagina = function () {
                $private.Pagina = $(this).text();
                var dataInicio = $("#dataInicio").val();
                var dataFim = $("#dataFim").val();

                historicoProxy.Listar(dataInicio, dataFim, $private.TipoAcesso, $private.Pagina).done($private.AtualizarResultados);

            };
            $private.ProximaPagina = function () {
                $private.Pagina++;
                var dataInicio = $("#dataInicio").val();
                var dataFim = $("#dataFim").val();

                historicoProxy.Listar(dataInicio, dataFim, $private.TipoAcesso, $private.Pagina).done($private.AtualizarResultados);


            };
            $private.PaginaAnterior = function () {
                $private.Pagina--;
                var dataInicio = $("#dataInicio").val();
                var dataFim = $("#dataFim").val();

                historicoProxy.Listar(dataInicio, dataFim, $private.TipoAcesso, $private.Pagina).done($private.AtualizarResultados);

            };

            $private.ConsultarHistorico = function () {
                $private.Pagina = 1;
                var dataInicio = $("#dataInicio").val();
                var dataFim = $("#dataFim").val();
                historicoProxy.Listar(dataInicio, dataFim, $private.TipoAcesso, $private.Pagina).done($private.AtualizarResultados);
            };


            $private.CalcularPaginaMinima = function (quantidade, pagina) {
                if (pagina < 4) {
                    return 1;
                }
                else if (pagina > quantidade - 3) {
                    return quantidade - 4;
                }
                else {
                    return pagina - 2;
                }
            };

            $private.CalcularPaginaMaxima = function (quantidade, pagina) {
                if (pagina < 4) {
                    if (quantidade < 6) {
                        return quantidade + 1;
                    }
                    else {
                        return 6;
                    }
                }
                else if (pagina > quantidade - 3) {
                    return quantidade + 1;
                }
                else {
                    return pagina + 3;
                }
            };

            $private.AtualizarResultados = function (data) {
                $("#historico-container").html($private.HistoricoTemplate(data));
                if (data.HasNext) {
                    $(".historico-paginacao-proxima").show();
                }
                else {
                    $(".historico-paginacao-proxima").hide();
                }

                if (data.HasPrevious) {
                    $(".historico-paginacao-anterior").show();
                }
                else {
                    $(".historico-paginacao-anterior").hide();
                }

               
                $("#paginacao-container").html($private.PaginacaoTemplate({
                    paginas: Math.ceil(data.Count / 8),
                    possuiAnterior: data.HasPrevious,
                    possuiProxima: data.HasNext,
                    paginaMin: $private.CalcularPaginaMinima(Math.ceil(data.Count / 8), 1),
                    paginaMax: $private.CalcularPaginaMaxima(Math.ceil(data.Count / 8), 1),
                    paginaCorrente: $private.Pagina
                }));
                 
               
            };

        }(SmartLMS.HistoricoProxy));
    </script>
}